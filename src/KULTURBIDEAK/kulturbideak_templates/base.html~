<html>
<head>
{% load i18n %}
{# Load the tag library #}
<script charset="utf-8" type="text/javascript" src="{{STATIC_URL}}js/jquery-1.9.1.js"></script>
{% load bootstrap3 %}
<script charset="utf-8" type="text/javascript" src="{{STATIC_URL}}js/raphael-min.js"></script>
{# Load CSS and JavaScript #}
<script charset="utf-8" type="text/javascript" src="{{STATIC_URL}}js/main.js"></script>
<script charset="utf-8" type="text/javascript" src="{{STATIC_URL}}js/kulturbideak.js"></script>
{% bootstrap_css %}
{% bootstrap_javascript %}

{# Display django.contrib.messages as Bootstrap alerts #}
{% bootstrap_messages %}


<style type="text/css">
    body{
        font-family: Verdana,Arial,sans-serif;
    }

    .page_head{
        height: 200px;
    }
    
   .bilaketaEmaitza{

		background-image: url("/home/maddalen/Documents/Aptana Studio 3 Workspace/KULTURBIDEAK/src/KULTURBIDEAK/kulturbideak_app/media/uploads/NoIrudiItem.png");
		min-height: 120px;
		background-size: 120px 120px;
	
	}
	
    #workspace{
        position:fixed;
        width: 80%;
        min-width: 800px;
        left: 10%;
        text-align: center;
        z-index: 100;
    }

    #workspace_boxes{
        overflow: auto;
        display: block;
        height: 0;
        border: 1px solid #808080;
        background: lightblue;
        opacity: 0;
        -webkit-transition: height 1s,opacity 1s ease-in-out;
        transition: height 1s,opacity 1s ease-in-out;
    }

    .open{
        height: 300px!important;
        opacity: 100!important;
    }

    .close{
        overflow: hidden!important;
    }
    
    .ws_box{
        border: 1px solid;
        display: inline-block;
        height: 50px;
        margin: 5px 5px;
        padding: 10px;
        width: 200px;
        vertical-align: top;
        cursor: move;
    }

    .wsb_image{
        float: left;
        max-height: 50px;
        max-width: 40px;
        margin-right: 10px;
        pointer-events: none;
    }

    .wsb_title{
        font-size: 10pt;
        pointer-events: none;
    }

    .wsb_button{
        cursor: pointer;
        display: inline-block;
        visibility: hidden;
        font-size: 8pt;
        font-weight: bold;
        float: right;
    }

    .ws_box:hover .wsb_button{
        visibility: visible;
    }

    .ws_box_over{
        border: 1px dotted #808080;
        background: #d3d3d3;
    }

    #path_boxes{
        width: 98%;
        height: 500px;
        display: block;
        border: 1px solid #808080;
        margin-top: 20px;
        background: #F3F3F3;
        overflow: auto;
        resize: both;
    }
    
    #path_boxes svg{
        width: 100%;
        height: 100%;
    }

    .pb_box{
        cursor: move;
        fill: transparent;
        stroke: #000000;
        stroke-width:1;
    }

    .pb_box_back{
        fill: #ffffff;
    }

    .pb_box_title{
        font-size: 12pt!important;
    }

    .pb_box_image{
    }

    .pb_box_back_moving{
        fill: #808080;
        opacity: 0.5;
    }

    .pb_box_delete_button{
        cursor: pointer;
        font-weight: bold!important;
        font-size: 10pt!important;
    }
   .pb_box_delete_button{
        cursor: pointer;
        fill: #808080!important;
        font-weight: bold!important;
        font-size: 10pt!important;
    }

    .pb_box_delete_button:hover{
        fill: #000000!important;
    }
    
    .orria{
    	display: block;
    	margin: 0 auto;
    	text-align: center;
    }
    .eskuma_div{
    	width: 15%;
    	min-height: 500px;
    	display:inline-block;
		background: white;
		vertical-align: top;
		text-align: left;
		color:lightblue;
    }
    .ezkerra_div{
    	width: 15%;
    	min-height: 500px;
    	display:inline-block;
    	background:white;
		vertical-align: top;
		text-align: left;
		color: lightblue;
    }
    .content_div{
    	width: 65%;
    	min-height: 500px;
    	display:inline-block;
    	background: white;
		vertical-align: top;
		margin: 0 20px;
		text-align: left;
    }
    .erabiltzaile-menua{
    	font-size: 9pt;
   		margin-top: 0.5em;font-size: 9pt;
   		text-align: right;
   
    }
   .pathBotoia{
   	text-align: right;
   	position:relative;
   	alignment-adjust: right;
   	
   }
   .footer{
   	bottom: 0;
   	position:fixed;
   	background: lightblue;
   	width: 95%;
   }
  .hizkuntzak_class {
    float: left;
    width: auto;
	}
	.ulhizkuntzak {
    font-size: 13px;
	}
	.ulhizkuntzak li {
	float: left;
	padding: 0px 6px 0px 6px;
	border-right: 2px solid #FFFFFF;
	color:transparent;
	
	}
	.ulhizkuntzak li:last-child {
	border-right: 0px;
	}
	#header-content {
    margin: 0 auto;
    max-width: 1024px;
    width: 100%;
	}
	.ulNon {
	margin: 3px 0px 0px 0px;
	float: left;
	}
	.ulNon li {
	float: left;
	padding: 0px 6px 0px 6px;
	border-right: 1px solid #928a83;
	font-size: 13px;
	}
	.ulNon li:last-child {
	border-right: 0px;
	}
	.ulNon li a {
	color: #928a83;
	}
	.ulNon li.active a {
	font-family: "MetaBold", Helvetica, Arial, Verdana, sans-serif;
	color: #60554b;
	}
	.ibilbide-panela{
		width: 98%;
	}
	
	


</style>
<script>

var paper = null;
var el_counter=0;
var svgns = "http://www.w3.org/2000/svg";
var pb_box_w = 160;
var pb_box_h = 120;
var pb_box_space = 20;
var paths_starts = [];
var connections = [];

function initialize(){
	//raphael martxan jartzeko
	set_pb();
	//kargatu workspaceko elementuak
	load_ws();
	//kargatu erabiltzailearen ibilbideak
	var user_id=1;
	load_paths_list(user_id);
}

function hizkuntza_url_egokitu(linka){
    //Hizkuntza aukeraketa egiten duen formularioaren url helbidea egokitzen du
    var form=document.getElementById("hizkuntza_aukeraketa_id");
    var hizkuntza=linka.text.toLowerCase();
    form.name="setLang"+hizkuntza;
    document.getElementsByName("language")[0].value=hizkuntza;
    document.getElementsByName("setLang"+hizkuntza)[0].submit();
    return false;

}

//pantailaren albo batean erabiltzailearen path-ak kargatzeko
function load_paths_list(user_id){
	var paths_list_container = document.getElementById("nire_ibilbideak");
	if (paths_list_container){
		//ajax deia, kargatu kontainerrean zerrenda
		load_paths_list_request(paths_list_container, user_id);
	}
}

function load_paths_list_request(paths_list_container,user_id)
{
	
	var csrftoken = getCookie('csrftoken');
	var xmlHttp = createXmlHttpRequestObject();
	
	if (xmlHttp.readyState == 4 || xmlHttp.readyState == 0){ 
		
		$.ajaxSetup({
   			beforeSend: function(xhr, settings) {
       		if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
           		xhr.setRequestHeader("X-CSRFToken", csrftoken);
       		}
   		 	}
		});
        xmlHttp.open("POST","../ajax_lortu_paths_list",true);
        xmlHttp.onreadystatechange = function (){
            load_paths_list_answer(xmlHttp,paths_list_container);                                                                   // Erantzuna jasotzean exekutatuko den deia
        };
        xmlHttp.setRequestHeader("Content-Type","application/x-www-form-urlencoded");
        xmlHttp.setRequestHeader("X-Requested-With", "XMLHttpRequest");
        xmlHttp.send("user_id=" + user_id  + "&csrfmiddlewaretoken=" + csrftoken);                       // Eskaera bidali
    }
}

function load_paths_list_answer(xmlHttp,paths_list_container)
{
	
	if (xmlHttp.readyState == 4){
        if(xmlHttp.status == 200){
			var xml_answer = xmlHttp.responseXML;
			var xml_Document = xml_answer.documentElement;
			var paths = xml_Document.getElementsByTagName("path");
			for (var i=0;i<paths.length;i++){
				id = paths[i].getElementsByTagName("id")[0].firstChild.data;
				titulua = paths[i].getElementsByTagName("titulua")[0].firstChild.data;
				deskribapena = paths[i].getElementsByTagName("deskribapena")[0].firstChild.data;
				irudia = paths[i].getElementsByTagName("irudia")[0].firstChild.data;
				add_path_to_list(id,titulua,deskribapena,irudia);
			}                                 
        }
    }
	
}
function add_path_to_list(id,titulua,deskribapena,irudia){
	
	var ibilbideak_div = document.getElementById("nire_ibilbideak");
    
    var p = document.createElement('p');
    
    var a = document.createElement('a');
	var linkText = document.createTextNode(titulua);
	a.appendChild(linkText);
	a.title = titulua;
	a.href = "editatu_ibilbidea?id="+id;
	ibilbideak_div.appendChild(p);
	ibilbideak_div.appendChild(a);
    
    
}

function load_ws()
{
	var user_id =1;
	var ws_id=1;
	load_ws_request(user_id,ws_id);	
}

function load_ws_request(user_id,ws_id){
	
	
	var csrftoken = getCookie('csrftoken');
	var xmlHttp = createXmlHttpRequestObject();
	
	if (xmlHttp.readyState == 4 || xmlHttp.readyState == 0){ 
		
		$.ajaxSetup({
   			beforeSend: function(xhr, settings) {
       		if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
           		xhr.setRequestHeader("X-CSRFToken", csrftoken);
       		}
   		 	}
		});
        xmlHttp.open("POST","../ajax_load_ws",true);
        xmlHttp.onreadystatechange = function (){
            load_ws_answer(xmlHttp);                                                                   // Erantzuna jasotzean exekutatuko den deia
        };
        xmlHttp.setRequestHeader("Content-Type","application/x-www-form-urlencoded");
        xmlHttp.setRequestHeader("X-Requested-With", "XMLHttpRequest");
        xmlHttp.send("user_id=" + user_id +"&ws_id="+ ws_id + "&csrfmiddlewaretoken=" + csrftoken);                       // Eskaera bidali
    }
}

function load_ws_answer(xmlHttp){
	  if (xmlHttp.readyState == 4){
        if(xmlHttp.status == 200){
			var xml_answer = xmlHttp.responseXML;
			var xml_Document = xml_answer.documentElement;
			var items = xml_Document.getElementsByTagName("item");
			for (var i=0;i<items.length;i++){
				id = items[i].getElementsByTagName("id")[0].firstChild.data;
				titulua = items[i].getElementsByTagName("titulua")[0].firstChild.data;
				irudia = items[i].getElementsByTagName("irudia")[0].firstChild.data;
				//irudia hutsa baldin bada, defektuzkoa pasa
				if (irudia =="None")
				{
					irudia="/home/maddalen/Documents/Aptana Studio 3 Workspace/KULTURBIDEAK/src/KULTURBIDEAK/kulturbideak_app/media/uploads/NoIrudiItem.png";
				}
				add_workspace_box(id,titulua,irudia);
			}                                 
        }
    }
	
}

function allowDrop(ev) {
    ev.preventDefault();
}

//CSRF tokena kontrolatzeko funtzioak
// using jQuery :::csrftoken-a lortzeko
function getCookie(name) {
    var cookieValue = null;
    if (document.cookie && document.cookie != '') {
        var cookies = document.cookie.split(';');
        for (var i = 0; i < cookies.length; i++) {
            var cookie = jQuery.trim(cookies[i]);
            // Does this cookie string begin with the name we want?
            if (cookie.substring(0, name.length + 1) == (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
function csrfSafeMethod(method) {
    // these HTTP methods do not require CSRF protection
    return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
}




function remove_me(element,item_id){
	//AJAX-HASI
	
	start_loader("loader");                          
	create_remove_me_request(element,item_id);                                       	                                                           
	stop_loader("loader");                                                  
	
    //element.parentNode.removeChild(element);
}

//create workspace_box request
function create_remove_me_request(element,item_id)
{
	//var csrfmiddlewaretoken = document.getElementsByName('csrfmiddlewaretoken')[0].value;
	var csrftoken = getCookie('csrftoken');
	var xmlHttp = createXmlHttpRequestObject();
	
	if (xmlHttp.readyState == 4 || xmlHttp.readyState == 0){ 
		
		$.ajaxSetup({
   			beforeSend: function(xhr, settings) {
       		if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
           		xhr.setRequestHeader("X-CSRFToken", csrftoken);
       		}
   		 	}
		});
		
        xmlHttp.open("POST","../ajax_workspace_item_borratu",true);
        xmlHttp.onreadystatechange = function (){
            create_remove_me_answer(xmlHttp,element);                                                                   
        };
        xmlHttp.setRequestHeader("Content-Type","application/x-www-form-urlencoded");
        xmlHttp.setRequestHeader("X-Requested-With", "XMLHttpRequest");
        xmlHttp.send("item_id=" + item_id  + "&csrfmiddlewaretoken=" + csrftoken);                     
    }
	
	
}

//create remove_me answer
function create_remove_me_answer(xmlHttp,element){
    if (xmlHttp.readyState == 4){
        if(xmlHttp.status == 200){
    		var item_id = server_answer(xmlHttp);
            if (item_id){ 
            	element.parentNode.removeChild(element);           	
			}
			else{                                                                                               // Jaso beharreko emaitza lortu ez bada, errorea
				//show_message("default_error"); //AURRERAGO DIALOG BOX BAT adibidez
				alert ("default error");
			}
			stop_loader("loader");                                                                              // Emaitza ona edo txarra jaso bada, loaderra paratu
        }
    }
}

//workspace funtzioak
function toggle_workspace(){
	//Datu-basetik kargatu item-ak
	var ws = document.getElementById("workspace_boxes");
    if (ws.getAttribute("class") == "open"){
        ws.setAttribute("class","close");
    }
    else{
        ws.setAttribute("class","open");
    }
}

function create_workspace_box(index){
   	el_counter++;
    var item_id = document.getElementById("item_id_"+index).value;
    var titulua = document.getElementById("titulua_"+index).value;	
    var irudia = document.getElementById("irudia_"+index).value;
   
    //Ondoren user id-aren arabera WS-id-a lortu
    var fk_workspace_id=1;
    var uri="uri_"+item_id;
    var dc_source="Euskomedia";
    var dc_title=titulua;
    var dc_description="description";
    var type="argazkia";
    var paths_thumbnail=irudia;
   	//  workspace_item taula:item_id, item_uri, ws_id, item_dc_source, item_dc_title, item_dc_descriptioon, type, thumnail
  	
  	//AJAX
  	start_loader("loader");                             
	if (item_id.value != ""){		                                       
		create_workspace_box_request(item_id,fk_workspace_id,uri,dc_source,dc_title,dc_description,type,paths_thumbnail);                                       //request!
	}
	else{                                                                                                       // baldintzak bete ez badira
		show_message("empty_workspace_box_error");                                                                  // (aukeran) errorea 
	stop_loader("loader");                                                                                      // loaderra gelditu
	}
   
	
    //add_workspace_box(item_id,titulua,irudia);
}



//create workspace_box request
function create_workspace_box_request(item_id,fk_workspace_id,uri,dc_source,dc_title,dc_description,type,paths_thumbnail)
{
//var csrfmiddlewaretoken = document.getElementsByName('csrfmiddlewaretoken')[0].value;
	var csrftoken = getCookie('csrftoken');
	var xmlHttp = createXmlHttpRequestObject();
	
	if (xmlHttp.readyState == 4 || xmlHttp.readyState == 0){ 
		
		$.ajaxSetup({
   			beforeSend: function(xhr, settings) {
       		if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
           		xhr.setRequestHeader("X-CSRFToken", csrftoken);
       		}
   		 	}
		});
		
        xmlHttp.open("POST","../ajax_workspace_item_gehitu",true);
        xmlHttp.onreadystatechange = function (){
            create_workspace_box_answer(xmlHttp,item_id,dc_title,paths_thumbnail);                                                                   
        };
        xmlHttp.setRequestHeader("Content-Type","application/x-www-form-urlencoded");
        xmlHttp.setRequestHeader("X-Requested-With", "XMLHttpRequest");
        xmlHttp.send("item_id="+item_id+"&fk_workspace_id=" + fk_workspace_id + "&uri=" + uri + "&dc_source=" + dc_source + "&dc_title=" + dc_title + "&dc_description=" + dc_description + "&type=" + type + "&paths_thumbnail=" + paths_thumbnail + "&csrfmiddlewaretoken=" + csrftoken);                     
    }
	
	
}
//create workspace box answer
function create_workspace_box_answer(xmlHttp,item_id,titulua,irudia){
    if (xmlHttp.readyState == 4){
        if(xmlHttp.status == 200){
    		var item_id = server_answer(xmlHttp);
            if (item_id){ 
            	
            	//Datu-basean sartu den Id-a nahi dut
            	add_workspace_box(item_id,titulua,irudia);
			}
			else{                                                                                               // Jaso beharreko emaitza lortu ez bada, errorea
				//show_message("default_error"); //AURRERAGO DIALOG BOX BAT adibidez
				alert ("default error");
			}
			stop_loader("loader");                                                                              // Emaitza ona edo txarra jaso bada, loaderra paratu
        }
    }
}

function add_workspace_box(box_id,text_value,image_value){
	
	var ws = document.getElementById("workspace_boxes");
    
    var ws_box = document.createElement("div");
    //ws_box.setAttribute("id","ws_box_" + box_id);
    ws_box.setAttribute("id", box_id);
    ws_box.setAttribute("class","ws_box");
    ws_box.setAttribute("draggable","true");
    ws_box.addEventListener('dragstart',drag);
    ws_box.addEventListener('dragenter',wsb_handleDragEnter);
    ws_box.addEventListener('dragleave',wsb_handleDragLeave);

    var wsb_button = document.createElement("span");
    wsb_button.setAttribute("class","wsb_button");
    wsb_button.setAttribute("onclick","remove_me(this.parentNode,"+box_id+");");
    wsb_button.appendChild(document.createTextNode("Ezabatu"));
    ws_box.appendChild(wsb_button);

    var wsb_image = document.createElement("img");
    wsb_image.setAttribute("class","wsb_image");
    wsb_image.setAttribute("src",image_value);
    ws_box.appendChild(wsb_image);

    var wsb_title = document.createElement("span");
    wsb_title.setAttribute("class","wsb_title");
    wsb_title.appendChild(document.createTextNode(text_value));
    ws_box.appendChild(wsb_title);

    ws.appendChild(ws_box);
}


function ws_drop(ev) {
    ev.preventDefault();
    var data = ev.dataTransfer.getData("id");
    var source = document.getElementById(data);
    if (source){
        if (ev.target.id == "workspace_boxes"){
            ev.target.appendChild(source);
        }
        else if (ev.target.classList.contains("ws_box")){
            ev.target.classList.remove('ws_box_over');
            ev.target.parentNode.insertBefore(source,ev.target.nextElementSibling);
        }
    }
}

function drag(ev) {
    ev.dataTransfer.setData("id", ev.target.id);
}

function wsb_handleDragEnter(ev) {
    ev.preventDefault();
    if (ev.target.classList){
        ev.target.classList.add('ws_box_over');
    }
}

function wsb_handleDragLeave(ev) {
    if (ev.target.classList){
        ev.target.classList.remove('ws_box_over');
    }
}

//path box funtzioak


function update_path_on_db(path_id)
{
	
	start_loader("loader");  
	                                                                                    // beharrezko baldintzak jaso
	
	if (paths_starts.length > 0){
		                                            
		update_path_on_db_request(path_id);                                  
	}
	else{                                                                                                       // baldintzak bete ez badira
		alert("empty_path_error");                                                                  // (aukeran) errorea 
	}
	stop_loader("loader");   
}

function update_path_on_db_request(path_id)
{
	
	var csrftoken = getCookie('csrftoken');
	var xmlHttp = createXmlHttpRequestObject();
	
	if (xmlHttp.readyState == 4 || xmlHttp.readyState == 0){ 
		
		$.ajaxSetup({
   			beforeSend: function(xhr, settings) {
       		if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
           		xhr.setRequestHeader("X-CSRFToken", csrftoken);
       		}
   		 	}
		});
		
        xmlHttp.open("POST","../ajax_path_eguneratu",true);
        xmlHttp.onreadystatechange = function (){
            update_path_on_db_answer(xmlHttp,path_id);                                                                   
        };
      
        xmlHttp.setRequestHeader("Content-Type","application/x-www-form-urlencoded");
        xmlHttp.setRequestHeader("X-Requested-With", "XMLHttpRequest");
        xmlHttp.send("path_id="+path_id+"&csrfmiddlewaretoken=" + csrftoken);                     
    }
	
}


function update_path_on_db_answer(xmlHttp,path_id)
{
	if (xmlHttp.readyState == 4){
        if(xmlHttp.status == 200){
    		var path_id = server_answer(xmlHttp);
            if (path_id){ 
            
            	//ORAIN NODE TAULA EGUNERATU
            	update_path_nodes(path_id);
            	
            	
			}
			else{                                                                                               // Jaso beharreko emaitza lortu ez bada, errorea
				//show_message("default_error"); //AURRERAGO DIALOG BOX BAT adibidez
				alert ("default error");
			}
			stop_loader("loader");                                                                              // Emaitza ona edo txarra jaso bada, loaderra paratu
        }
    }
	
}

function update_path_nodes(path_id)
{
	
	//NODE BAKOITZEKO
	start_loader("loader");
	//Erroak
	var nodes = paths_starts;
	for(var i = 0; i < nodes.length; i++) {
		var erroa=paper.getById(nodes[i]);

		var item_id= erroa.id;
		var uri="uri_"+erroa.id;
		var dc_source="Euskomedia";
		var dc_description="desc";
		var type ="argazkia";
		var paths_thumbnail=erroa.data("image_value");
		
		
		
		var paths_prev =(erroa.data("parent_id"))?erroa.data("parent_id"):"";
		
		var dc_title =erroa.data("text_value");
		var semeak =erroa.data("children");
		var paths_next=semeak.join();
		var paths_start =(erroa.data("parent_id"))?0:1;
			
		update_path_nodes_request(path_id,item_id,uri,dc_source,dc_title,dc_description,type,paths_thumbnail,paths_prev,paths_next,paths_start);
		nodes = nodes.concat(semeak);
	}

	stop_loader("loader");           
	
}

function update_path_nodes_request(path_id,item_id,uri,dc_source,dc_title,dc_description,type,paths_thumbnail,paths_prev,paths_next,paths_start)
{
	
	var csrftoken = getCookie('csrftoken');
	var xmlHttp = createXmlHttpRequestObject();
	
	if (xmlHttp.readyState == 4 || xmlHttp.readyState == 0){ 
		
		$.ajaxSetup({
   			beforeSend: function(xhr, settings) {
       		if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
           		xhr.setRequestHeader("X-CSRFToken", csrftoken);
       		}
   		 	}
		});
		
        xmlHttp.open("POST","../ajax_path_node_eguneratu",true);
        xmlHttp.onreadystatechange = function (){
            update_path_node_answer(xmlHttp);                                                                   
        };
      
        xmlHttp.setRequestHeader("Content-Type","application/x-www-form-urlencoded");
        xmlHttp.setRequestHeader("X-Requested-With", "XMLHttpRequest");
        xmlHttp.send("path_id="+path_id+"&item_id="+item_id+"&uri="+uri+"&dc_source="+dc_source+"&dc_title="+dc_title+"&dc_description="+dc_description+"&type="+type+"&paths_thumbnail="+paths_thumbnail+"&paths_prev="+paths_prev+"&paths_next="+paths_next+"&paths_start="+paths_start+"&csrfmiddlewaretoken=" + csrftoken); 																																			
    }
}

function update_path_node_answer(xmlHttp)
{
	
	if (xmlHttp.readyState == 4){
        if(xmlHttp.status == 200){
    		var path_node_id = server_answer(xmlHttp);
            if (path_node_id){
            	//alert ("gorde da nodea:"+path_node_id);
            	console.log("eguneratu da nodea:"+path_node_id);
            	document.getElementById("update_path_button").setAttribute("disabled","disabled");
			}
			else{                                                                                               // Jaso beharreko emaitza lortu ez bada, errorea
				//show_message("default_error"); //AURRERAGO DIALOG BOX BAT adibidez
				alert ("default error");
			}
			stop_loader("loader");                                                                              // Emaitza ona edo txarra jaso bada, loaderra paratu
        }
    }
}



function create_path_on_db()
{
	var dc_title = prompt("Ibilbidearen titulua", "");
	var dc_description = prompt("Ibilbidearen deskribapena", "");
	var dc_subject = prompt("Ibilbidearen gaia", "");
	start_loader("loader");  
	
	uri="urii";
   
    paths_thumbnail = "irudia";                                                                                        // beharrezko baldintzak jaso
	
	if (paths_starts.length > 0){
		                                            
		create_path_on_db_request(uri,dc_title,dc_subject,dc_description,paths_thumbnail);                                  
	}
	else{                                                                                                       // baldintzak bete ez badira
		alert("empty_path_error");                                                                  // (aukeran) errorea 
	}
	stop_loader("loader");                                                                                      // loaderra gelditu

}
	
function create_path_on_db_request(uri,dc_title,dc_subject,dc_description,paths_thumbnail)
{
	
	var csrftoken = getCookie('csrftoken');
	var xmlHttp = createXmlHttpRequestObject();
	
	if (xmlHttp.readyState == 4 || xmlHttp.readyState == 0){ 
		
		$.ajaxSetup({
   			beforeSend: function(xhr, settings) {
       		if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
           		xhr.setRequestHeader("X-CSRFToken", csrftoken);
       		}
   		 	}
		});
		
        xmlHttp.open("POST","../ajax_path_berria_gorde",true);
        xmlHttp.onreadystatechange = function (){
            create_path_on_db_answer(xmlHttp);                                                                   
        };
      
        xmlHttp.setRequestHeader("Content-Type","application/x-www-form-urlencoded");
        xmlHttp.setRequestHeader("X-Requested-With", "XMLHttpRequest");
        xmlHttp.send("uri="+uri+"&dc_title="+dc_title+"&dc_subject="+dc_subject+"&dc_description="+dc_description+"&paths_thumbnail="+paths_thumbnail+"&csrfmiddlewaretoken=" + csrftoken);                     
    }
	
}


function create_path_on_db_answer(xmlHttp)
{
	if (xmlHttp.readyState == 4){
        if(xmlHttp.status == 200){
    		var path_id = server_answer(xmlHttp);
            if (path_id){ 
            
            	//ORAIN NODE TAULA EGUNERATU
            	create_path_nodes(path_id);
            	
            	//add_workspace_box(item_id,titulua,irudia);
			}
			else{                                                                                               // Jaso beharreko emaitza lortu ez bada, errorea
				//show_message("default_error"); //AURRERAGO DIALOG BOX BAT adibidez
				alert ("default error");
			}
			stop_loader("loader");                                                                              // Emaitza ona edo txarra jaso bada, loaderra paratu
        }
    }
	
}

function create_path_nodes(path_id)
{
		
	//NODE BAKOITZEKO
	start_loader("loader");
	//Erroak
	var nodes = paths_starts;
	for(var i = 0; i < nodes.length; i++) {
		var erroa=paper.getById(nodes[i]);

		var item_id= erroa.id;
		var uri="uri_"+erroa.id;
		var dc_source="Euskomedia";
		var dc_description="desc";
		var type ="argazkia";
		var paths_thumbnail=erroa.data("image_value");
		
		
		
		var paths_prev =(erroa.data("parent_id"))?erroa.data("parent_id"):"";
		
		var dc_title =erroa.data("text_value");
		var semeak =erroa.data("children");
		var paths_next=semeak.join();
		var paths_start =(erroa.data("parent_id"))?0:1;
			
		create_path_nodes_request(path_id,item_id,uri,dc_source,dc_title,dc_description,type,paths_thumbnail,paths_prev,paths_next,paths_start);
		nodes = nodes.concat(semeak);
	}

	stop_loader("loader");           
	
	

	
}
function create_path_nodes_request(path_id,item_id,uri,dc_source,dc_title,dc_description,type,paths_thumbnail,paths_prev,paths_next,paths_start)
{
	
	var csrftoken = getCookie('csrftoken');
	var xmlHttp = createXmlHttpRequestObject();
	
	if (xmlHttp.readyState == 4 || xmlHttp.readyState == 0){ 
		
		$.ajaxSetup({
   			beforeSend: function(xhr, settings) {
       		if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
           		xhr.setRequestHeader("X-CSRFToken", csrftoken);
       		}
   		 	}
		});
		
        xmlHttp.open("POST","../ajax_path_node_gorde",true);
        xmlHttp.onreadystatechange = function (){
            create_path_node_answer(xmlHttp);                                                                   
        };
      
        xmlHttp.setRequestHeader("Content-Type","application/x-www-form-urlencoded");
        xmlHttp.setRequestHeader("X-Requested-With", "XMLHttpRequest");
        xmlHttp.send("path_id="+path_id+"&item_id="+item_id+"&uri="+uri+"&dc_source="+dc_source+"&dc_title="+dc_title+"&dc_description="+dc_description+"&type="+type+"&paths_thumbnail="+paths_thumbnail+"&paths_prev="+paths_prev+"&paths_next="+paths_next+"&paths_start="+paths_start+"&csrfmiddlewaretoken=" + csrftoken); 																																			
    }
}

function create_path_node_answer(xmlHttp)
{
	
	if (xmlHttp.readyState == 4){
        if(xmlHttp.status == 200){
    		var path_node_id = server_answer(xmlHttp);
            if (path_node_id){
            	//alert ("gorde da nodea:"+path_node_id);
            	console.log("gorde da nodea:"+path_node_id);
            	document.getElementById("create_path_button").setAttribute("disabled","disabled");
			}
			else{                                                                                               // Jaso beharreko emaitza lortu ez bada, errorea
				//show_message("default_error"); //AURRERAGO DIALOG BOX BAT adibidez
				alert ("default error");
			}
			stop_loader("loader");                                                                              // Emaitza ona edo txarra jaso bada, loaderra paratu
        }
    }
}

function set_pb(){
    if (document.getElementById("path_boxes") && (document.getElementById("path_boxes").children.length == 0)){
        paper = Raphael(document.getElementById("path_boxes"), "100%", "100%");
    }
}
function get_x(pos){
    return (pb_box_space + pos*(pb_box_space + pb_box_w));
}

function get_y(pos){
    return (pb_box_space + pos*(pb_box_space + pb_box_h));
}

function get_x_pos(x){
    return parseInt((x - pb_box_space)/(pb_box_space + pb_box_w));
}

function get_y_pos(y){
    return parseInt((y - pb_box_space)/(pb_box_space + pb_box_h));
}

function pb_drop(ev) {
    ev.preventDefault();
    var data = ev.dataTransfer.getData("id");
    var source = document.getElementById(data);
    if ((ev.target.parentNode.id == "path_boxes") && source && source.getAttribute("class") == "ws_box") {
        var image_value = source.children[1].src;
        var text_value = source.children[2].firstChild.data;
        pb_new_element(data,text_value,image_value);
        //alert(data);//ws_box_1
        var item_id=data.replace("ws_box_", "");
        remove_me(source,item_id);
    }
}

function pb_window_resize(){
    var svg = paper.canvas;
    var svgBBox = paper.canvas.getBBox();
    var container = svg.parentNode;
    if (svgBBox.height < container.offsetHeight){
        svg.style.height = (container.offsetHeight + pb_box_space) + "px";
    }
    else{
        svg.style.height = (svgBBox.height + (pb_box_space + pb_box_h)) + "px";
    }
    if (svgBBox.width < container.offsetWidth){
        svg.style.width = (container.offsetWidth + pb_box_space) + "px";
    }
    else{
        svg.style.width = (svgBBox.width + (pb_box_space + pb_box_w)) + "px";
    }

}

/*
Elementua sortu path box-ean
*/
function pb_new_element(data_id,text_value,image_value){
	console.log("data_id:"+data_id);
	console.log("text_value:"+text_value);
	console.log("image_value:"+image_value);
	
    //kokapen berria aurkitu
    var y_position = 0;
    if (paths_starts.length > 0){
        y_position = get_new_y(paper.getById(paths_starts[paths_starts.length-1]));
    }

    var back_rect = paper.rect(get_x(0), get_y(y_position), pb_box_w,pb_box_h, 5);
    back_rect.node.setAttribute("class","pb_box_back");
    back_rect.id = data_id + "_back";

    //azpi elementuak sortu
    if (text_value.length > 15){
        text_value = text_value.substring(0,12) + "...";
    }
    var text = paper.text(get_x(0)+60, get_y(y_position)+100, text_value);
    text.id = data_id + "_title";
    text.node.setAttribute("class","pb_box_title");

    var image = paper.image(image_value, get_x(0)+10, get_y(y_position)+15, pb_box_w -20, pb_box_h - 50)
    image.id = data_id + "_image";
    image.node.setAttribute("class","pb_box_image");

    var rect = paper.rect(get_x(0), get_y(y_position), pb_box_w,pb_box_h, 5);
    rect.node.setAttribute("class","pb_box");
    rect.id = data_id;
    //beharrezko informazioa hemen gorde
    rect.data("text_value",text_value);
    rect.data("image_value",image_value);
    //diagramaren kudeaketarako beharrezko balioak
    rect.data("parent_id",null);
    rect.data("children",[]);
    rect.drag(onmove, onstart, onend);
    paths_starts.push(rect.id);

    var delete_button = paper.text(get_x(0)+pb_box_w-10, get_y(y_position)+10, "X");
    delete_button.id = data_id + "_delete_button";
    delete_button.node.setAttribute("class","pb_box_delete_button");
    delete_button.data("id_value",data_id);
    delete_button.click(pb_remove_me);
    pb_window_resize();
}

//get new element y size
function get_new_y(el){
    if (el){
        var children = el.data("children");
        if (children && (children.length > 0)){
            return get_new_y(paper.getById(children[children.length-1]));
        }
        else{
            return get_y_pos(el.attr("y")) + 1;
        }
    }
    return 0;
}

//geziak eguneratu
function update_arrows(pb_box){
    if (pb_box){
        for (var i = connections.length; i--;) {
            if ((connections[i].to == pb_box) || (connections[i].from == pb_box)){
                paper.connection(connections[i]);
            }
        }
    }
    else{
        for (var i = connections.length; i--;) {
            paper.connection(connections[i]);
        }
    }
}

function onmove(dx,dy,x0,y0,ev){
    //elementua mugitu
    this.attr({x: this.ox + dx, y: this.oy + dy});
    //azpi elementuak mugitu
    var back = paper.getById(this.id + "_back");
    back.attr({x: back.ox + dx, y: back.oy + dy});
    var text = paper.getById(this.id + "_title");
    text.attr({x: text.ox + dx, y: text.oy + dy});
    var image = paper.getById(this.id + "_image");
    image.attr({x: image.ox + dx, y: image.oy + dy});
    var delete_button = paper.getById(this.id + "_delete_button");
    delete_button.attr({x: delete_button.ox + dx, y: delete_button.oy + dy});
    var rect = document.getElementById("path_boxes").getBoundingClientRect();
    var x = x0 - rect.left - window.pageXOffset + paper.canvas.parentNode.scrollLeft, y = y0 - rect.top - window.pageYOffset + paper.canvas.parentNode.scrollTop;
    var me = this;
    var found = false;
    paper.getElementsByPoint(x, y).forEach(function(e){
            if (e.node.classList.contains("pb_box") && (e.id != me.id)){
                me.data("hover_id",e.id);
                paper.getById(e.id + "_back").node.classList.add("pb_box_back_moving");
                found = true;
            }
    });
    if (!found){
        if (this.data("hover_id")){
            paper.getById(this.data("hover_id") + "_back").node.classList.remove("pb_box_back_moving");
            me.removeData("hover_id");
        }
    }
    update_arrows();
}

function onstart(x,y,ev){
    //azpi elementuak aurrera bota
    var back = paper.getById(this.id + "_back");
    back.ox = back.attr("x");
    back.oy = back.attr("y");
    back.toFront();
    var text = paper.getById(this.id + "_title");
    text.ox = text.attr("x");
    text.oy = text.attr("y");
    text.toFront();
    var image = paper.getById(this.id + "_image");
    image.ox = image.attr("x");
    image.oy = image.attr("y");
    image.toFront();
    //elementua aurrera bota
    this.ox = this.attr("x");
    this.oy = this.attr("y");
    this.toFront();
    //ezabatzeko botoia aurrera bota
    var delete_button = paper.getById(this.id + "_delete_button");
    delete_button.ox = delete_button.attr("x");
    delete_button.oy = delete_button.attr("y");
    delete_button.toFront();
    paper.getById(this.id + "_back").node.classList.add("pb_box_back_moving");
}

function onend(ev){
    var old_parent_id = this.data("parent_id");
    if (this.data("hover_id") && (old_parent_id != paper.getById(this.data("hover_id")).id)){
        var new_parent = paper.getById(this.data("hover_id"));
        pb_remove_box(this,false);
        pb_add_son(new_parent,this);
        paper.getById(new_parent.id + "_back").node.classList.remove("pb_box_back_moving");
        paper.getById(this.id + "_back").node.classList.remove("pb_box_back_moving");
    }
    else{
        //elementua mugitu
        this.attr({x: this.ox, y: this.oy});
        //azpi elementuak mugitu
        var back = paper.getById(this.id + "_back");
        back.attr({x: back.ox, y: back.oy});
        var text = paper.getById(this.id + "_title");
        text.attr({x: text.ox, y: text.oy});
        var image = paper.getById(this.id + "_image");
        image.attr({x: image.ox, y: image.oy});
        var delete_button = paper.getById(this.id + "_delete_button");
        delete_button.attr({x: delete_button.ox, y: delete_button.oy});
        paper.getById(this.id + "_back").node.classList.remove("pb_box_back_moving");
        update_arrows(this);
        //itzala kendu
        if (this.data("hover_id")){
            paper.getById(this.data("hover_id") + "_back").node.classList.remove("pb_box_back_moving");
            this.removeData("hover_id");
        }
    }
    pb_window_resize();
}

/*
Ezabatu bere burua
*/
function pb_remove_me(){
    pb_remove_box(paper.getById(this.data("id_value")),true);
    pb_window_resize();
}

/*
Ezabatu elementua:
    
    elementua workspacera bidaltzen du
    erlazionaturiko gezi guztiak ezabatu
    azpi elementuak ezabatzen ditu
    bere burua ezabatzen du

aparte egin beharrekoa:
    
    azpian dauden elementuak maila bat igo
*/
function pb_remove_box(pb_box,delete_element){
    var old_parent_id = pb_box.data("parent_id");
    var children = pb_box.data("children");
    if (old_parent_id){
        var old_parent = paper.getById(old_parent_id);
        if (children.length > 0){
            pb_children_left(pb_box);
        }
        else if (old_parent.data("children").length > 1){
            pb_brothers_up(pb_box);
        }
        old_parent.data("children").splice(old_parent.data("children").indexOf(pb_box.id),1);
        for (var i = connections.length; i--;) {
            if ((connections[i].to == pb_box)){
                connections[i].line.remove();
                connections.splice(i,1);
                break;
            }
        }
    }
    else{
        if (children.length > 0){
            pb_children_left(pb_box);
        }
        else{
            pb_brothers_up(pb_box);
        }
        paths_starts.splice(paths_starts.indexOf(pb_box.id),1);
    }
    update_arrows();
    if (delete_element){
        //workspace-an sortu elementua
        var box_id = pb_box.id;
        var text_value = pb_box.data("text_value");
        var image_value = pb_box.data("image_value");
        add_workspace_box(box_id,text_value,image_value);
        //ezabatu azpi elementuak
        paper.getById(pb_box.id + "_back").remove();
        paper.getById(pb_box.id + "_title").remove();
        paper.getById(pb_box.id + "_image").remove();
        paper.getById(pb_box.id + "_delete_button").remove();
        //ezabatu elementua
        pb_box.remove();
    }
}


/*
Semeak ezkerretara mugitu:
    guraso berria esleitu edo erro bezala ezarri
    pb_move_left funtzioa aplikatu elementuari
    elementu eta azpi-elementu guztiak ezkerrera mugitu
    geziak eguneratu
*/
function pb_children_left(parent){
    var children = parent.data("children");
    parent.data("children",[]);
    for (var c=0;c<children.length; c++){
        var child = paper.getById(children[c])
        //gurasoak gurasorik badu, elementuaren guraso berria bihurtuko da
        if (parent.data("parent_id")){
            //geziak ezabatu
            for (var i = connections.length; i--;) {
                if ((connections[i].to == child) && (connections[i].from == parent)){
                    connections[i].line.remove();
                    connections.splice(i,1);
                    break;
                }
            }
            var new_parent = paper.getById(parent.data("parent_id"));
            var connection = paper.connection(new_parent,child, "#000");
            connections.push(connection);
            new_parent.data("children").splice(new_parent.data("children").indexOf(parent.id),0,child.id);
            child.data("parent_id",new_parent.id);
        }
        //bestela erro elementua bihurtuko da
        else{
            //geziak ezabatu
            for (var i = connections.length; i--;) {
                if ((connections[i].to == child) && (connections[i].from == parent)){
                    connections[i].line.remove();
                    connections.splice(i,1);
                    break;
                }
            }
            paths_starts.splice(paths_starts.indexOf(parent.id),0,child.id);
            child.data("parent_id",null);
        }
        //elementua eta azpi elementuak mugitu
        pb_move_left(child);
    }
    update_arrows();
}

/*
Elementuak ezkerretara mugitu:
    x - 1 aplikatu elementuei
    seme bakoitzari ere deia aplikatu
*/
function pb_move_left(pb_box){
    //elementua mugitu
    pb_box.attr({x: pb_box.attr("x") - (pb_box_space + pb_box_w), y: pb_box.attr("y")});
    //azpi elementuak mugitu
    var back = paper.getById(pb_box.id + "_back");
    back.attr({x: back.attr("x") - (pb_box_space + pb_box_w), y: back.attr("y")});
    var text = paper.getById(pb_box.id + "_title");
    text.attr({x: text.attr("x") - (pb_box_space + pb_box_w), y: text.attr("y")});
    var image = paper.getById(pb_box.id + "_image");
    image.attr({x: image.attr("x") - (pb_box_space + pb_box_w), y: image.attr("y")});
    var delete_button = paper.getById(pb_box.id + "_delete_button");
    delete_button.attr({x: delete_button.attr("x") - (pb_box_space + pb_box_w), y: delete_button.attr("y")});
    var children = pb_box.data("children");
    for (var c=0;c<children.length; c++){
        pb_move_left(paper.getById(children[c]));
    }
}

/*
Elementu anaiak igo:
    anaiei pb_move_up aplikatu continue false
    gurasoak azpi-anairik duen konprobatu, hauei pb_move_up aplikatu continue false
    guraso gabeko azken gurasoa hartzean, erro zerrendatik hurrengo elementuak hartu eta hauei pb_move_up aplikatu
*/

function pb_brothers_up(pb_box){
    var parent_id = pb_box.data("parent_id");
    if (parent_id){
        var parent = paper.getById(parent_id);
        var next_children = parent.data("children").slice(parent.data("children").indexOf(pb_box.id)+1);
        for (var c=0;c<next_children.length; c++) {
            pb_move_up(paper.getById(next_children[c]));
        }
        pb_brothers_up(parent);
    }
    else{
        var next_paths_starts = paths_starts.slice(paths_starts.indexOf(pb_box.id)+1);
        for (var c=0;c<next_paths_starts.length; c++) {
            pb_move_up(paper.getById(next_paths_starts[c]));
        }
    }
}

/*
Elementuak gora:
    errekurtsiboa da.
    y - 1 aplikatu elementuei
    seme bakoitzari ere deia aplikatu
*/
function pb_move_up(pb_box){
    //elementuak mugitu
    pb_box.attr({x: pb_box.attr("x"), y: pb_box.attr("y") - (pb_box_space + pb_box_h)});
    //azpi elementuak mugitu
    var back = paper.getById(pb_box.id + "_back");
    back.attr({x: back.attr("x"), y: back.attr("y") - (pb_box_space + pb_box_h)});
    var text = paper.getById(pb_box.id + "_title");
    text.attr({x: text.attr("x"), y: text.attr("y") - (pb_box_space + pb_box_h)});
    var image = paper.getById(pb_box.id + "_image");
    image.attr({x: image.attr("x"), y: image.attr("y") - (pb_box_space + pb_box_h)});
    var delete_button = paper.getById(pb_box.id + "_delete_button");
    delete_button.attr({x: delete_button.attr("x"), y: delete_button.attr("y") - (pb_box_space + pb_box_h)});
    var children = pb_box.data("children");
    for (var c=0;c<children.length; c++){
        pb_move_up(paper.getById(children[c]));
    }
}

function pb_add_new_son(parent_id,data_id,text_value,image_value){
    var parent = paper.getById(parent_id)
    pb_new_element(data_id,text_value,image_value);
    var new_son = paper.getById(data_id);
    pb_brothers_up(new_son);
    paths_starts.splice(paths_starts.indexOf(data_id),1);
    pb_add_son(parent,new_son);
}

/*
Semea gehitu:
    semea gehitu eta dagokion marra
    esleitu gurasoa
    anaiak baditu:
        gurasoak azpi-anairik badu jaitsi +1 eta honen semeei errekurtsiboki
        guraso gabeko azken gurasoa hartzena, erro zerrendatik hurrengo elementuak hartu eta hauei pb_move_down aplikatu
*/
function pb_add_son(parent,pb_box){
    var back = paper.getById(pb_box.id + "_back");
    var text = paper.getById(pb_box.id + "_title");
    var image = paper.getById(pb_box.id + "_image");
    var delete_button = paper.getById(pb_box.id + "_delete_button");
    if (parent.data("children").length > 0){
        pb_brothers_down(parent);
        update_arrows();
        var last_son = paper.getById(parent.data("children")[parent.data("children").length-1]);
        y_position = get_new_y(last_son);
        //elementua mugitu
        pb_box.attr({x: last_son.attr("x"), y: get_y(y_position)});
        //azpi elementuak mugitu
        back.attr({x: last_son.attr("x"), y: get_y(y_position)});
        text.attr({x: last_son.attr("x") + 60, y: get_y(y_position) + 100});
        image.attr({x: last_son.attr("x") + 5, y: get_y(y_position) + 5});
        delete_button.attr({x: last_son.attr("x")+pb_box_w-10, y: get_y(y_position) + 10});
    }
    else{
        //elementua mugitu
        pb_box.attr({x: parent.attr("x") + (pb_box_space + pb_box_w), y: parent.attr("y")});
        //azpi elementuak mugitu
        back.attr({x: parent.attr("x") + (pb_box_space + pb_box_w), y: parent.attr("y")});
        text.attr({x: parent.attr("x") + (pb_box_space + pb_box_w) + 60, y: parent.attr("y") + 100});
        image.attr({x: parent.attr("x") + (pb_box_space + pb_box_w) + 5, y: parent.attr("y") + 5});
        delete_button.attr({x: parent.attr("x") + (pb_box_space + pb_box_w) + pb_box_w -10, y: parent.attr("y") + 10});
    }
    parent.data("children").push(pb_box.id);
    pb_box.data("parent_id",parent.id);
    var connection = paper.connection(parent,pb_box, "#000");
    connections.push(connection);
}

/*
Anaiak eta hurrengoak behera mugitu
*/
function pb_brothers_down(pb_box){
    var parent_id = pb_box.data("parent_id");
    if (parent_id){
        var parent = paper.getById(parent_id);
        var next_children = parent.data("children").slice(parent.data("children").indexOf(pb_box.id)+1);
        for (var c=0;c<next_children.length; c++) {
            pb_move_down(paper.getById(next_children[c]));
        }
        pb_brothers_down(parent);
    }
    else{
        var next_paths_starts = paths_starts.slice(paths_starts.indexOf(pb_box.id)+1);
        for (var c=0;c<next_paths_starts.length; c++) {
            pb_move_down(paper.getById(next_paths_starts[c]));
        }
    }
}

/*
Elementuak gora:
    errekurtsiboa da.
    y + 1 aplikatu elementuei
    seme bakoitzari ere deia aplikatu
*/
function pb_move_down(pb_box){
    pb_box.attr({x: pb_box.attr("x"), y: pb_box.attr("y") + (pb_box_space + pb_box_h)});
    var back = paper.getById(pb_box.id + "_back");
    back.attr({x: back.attr("x"), y: back.attr("y") + (pb_box_space + pb_box_h)});
    var text = paper.getById(pb_box.id + "_title");
    text.attr({x: text.attr("x"), y: text.attr("y") + (pb_box_space + pb_box_h)});
    var image = paper.getById(pb_box.id + "_image");
    image.attr({x: image.attr("x"), y: image.attr("y") + (pb_box_space + pb_box_h)});
    var delete_button = paper.getById(pb_box.id + "_delete_button");
    delete_button.attr({x: delete_button.attr("x"), y: delete_button.attr("y") + (pb_box_space + pb_box_h)});
    var children = pb_box.data("children");
    for (var c=0;c<children.length; c++){
        pb_move_down(paper.getById(children[c]));
    }
}

Raphael.fn.connection = function (obj1, obj2, line, bg) {
    if (obj1.line && obj1.from && obj1.to) {
        line = obj1;
        obj1 = line.from;
        obj2 = line.to;
    }
    var bb1 = obj1.getBBox(),
        bb2 = obj2.getBBox(),
        p = [{x: bb1.x + bb1.width / 2, y: bb1.y - 1},
        {x: bb1.x + bb1.width / 2, y: bb1.y + bb1.height + 1},
        {x: bb1.x - 1, y: bb1.y + bb1.height / 2},
        {x: bb1.x + bb1.width + 1, y: bb1.y + bb1.height / 2},
        {x: bb2.x + bb2.width / 2, y: bb2.y - 1},
        {x: bb2.x + bb2.width / 2, y: bb2.y + bb2.height + 1},
        {x: bb2.x - 1, y: bb2.y + bb2.height / 2},
        {x: bb2.x + bb2.width + 1, y: bb2.y + bb2.height / 2}],
        d = {}, dis = [];
    for (var i = 0; i < 4; i++) {
        for (var j = 4; j < 8; j++) {
            var dx = Math.abs(p[i].x - p[j].x),
                dy = Math.abs(p[i].y - p[j].y);
            if ((i == j - 4) || (((i != 3 && j != 6) || p[i].x < p[j].x) && ((i != 2 && j != 7) || p[i].x > p[j].x) && ((i != 0 && j != 5) || p[i].y > p[j].y) && ((i != 1 && j != 4) || p[i].y < p[j].y))) {
                dis.push(dx + dy);
                d[dis[dis.length - 1]] = [i, j];
            }
        }
    }
    if (dis.length == 0) {
        var res = [0, 4];
    } else {
        res = d[Math.min.apply(Math, dis)];
    }
    var x1 = p[res[0]].x,
        y1 = p[res[0]].y,
        x4 = p[res[1]].x,
        y4 = p[res[1]].y;
    dx = Math.max(Math.abs(x1 - x4) / 2, 10);
    dy = Math.max(Math.abs(y1 - y4) / 2, 10);
    var x2 = [x1, x1, x1 - dx, x1 + dx][res[0]].toFixed(3),
        y2 = [y1 - dy, y1 + dy, y1, y1][res[0]].toFixed(3),
        x3 = [0, 0, 0, 0, x4, x4, x4 - dx, x4 + dx][res[1]].toFixed(3),
        y3 = [0, 0, 0, 0, y1 + dy, y1 - dy, y4, y4][res[1]].toFixed(3);
    var path = ["M", x1.toFixed(3), y1.toFixed(3), "C", x2, y2, x3, y3, x4.toFixed(3), y4.toFixed(3)].join(",");
    if (line && line.line) {
        line.bg && line.bg.attr({path: path});
        line.line.attr({path: path});
    } else {
        var color = typeof line == "string" ? line : "#000";
        return {
            bg: bg && bg.split && this.path(path).attr({stroke: bg.split("|")[0], fill: "none", "stroke-width": bg.split("|")[1] || 3}),
            line: this.path(path).attr({stroke: color, fill: "none"}),
            from: obj1,
            to: obj2
        };
    }
};

function ibilbidea_kargatu(path_id)
{
	
	var path_id=path_id;
	//Datu-basetik erroak direnak lortu ->pb_new_element
	
	//Datu-basetik semeak lortzen joan ->pb_add_new_son
	/*
	  pb_new_element("box_1","Aita Donostiari omenaldia : ikonografi erreportaia","http://hedatuz.euskomedia.org/7031/1/03109132.pdf.png");
        pb_add_new_son("box_1","box_2","Legendarias regatas de traineras: las primeras décadas en el asentamiento del deporte de Remo de Banco Fijo en el Cantábrico (1844-1871)","http://hedatuz.euskomedia.org/8432/1/33341360.pdf.png");
        pb_new_element("box_3","Aquarium: 100 años de Historia","http://www.euskomedia.org/MusicGaler/foto/74_aquarium.jpg");
        pb_add_new_son("box_3","box_4","Celebración de la Tamborrada en Donostia-San Sebastián (Gipuzkoa) la madrugada del 20 de enero.","http://www.euskomedia.org/MusicGaler/foto/v000070.jpg");
        pb_add_new_son("box_3","box_5","Gran Casino Kursaal","http://www.euskomedia.org/ImgsGaler/onati/OAA00220.jpg");
        
	 */
}
</script>

</head>

<body style="padding-top:20px;" onload="initialize();">
	<!-- WORKSPACE -->
	<div id="workspace">
       	<div id="workspace_boxes" ondrop="ws_drop(event)" ondragover="allowDrop(event)">
       		<a type="button" class="btn btn-default btn-xs pathBotoia" href="sortu_ibilbidea">{% trans "sortu ibilbidea" %}
       		<span class="glyphicon glyphicon-edit" aria-hidden="true"> 
       		</span> 
      	 	</a>
       	</div>
       	<button type="button" class="btn btn-default btn-xs" onclick="toggle_workspace();">
       		<span class="glyphicon glyphicon-pencil" aria-hidden="true"> 
       		</span> 
       		{% trans "Lan eremua" %}    		
       	</button>
       	
    </div>
 
    <!-- END WORKSPACE -->
    
	<!-- PAGE -->
	<div  style="max-width:1140px;margin:0 auto;">
		
	<div class="header-content">
		<!-- HIZKUNTZAK -->
		<div class="hizkuntzak_class" >
			
		
			<form id="hizkuntza_aukeraketa_id" name="setLang{{ lang.1 }}" action="/i18n/setlang/" method="post">{% csrf_token %}
                <input name="next" type="hidden" value="#" />
                <input type="hidden" name="language" value="{{ lang.0 }}" />
                {% get_current_language as LANGUAGE_CODE %}
                <ul class="ulhizkuntzak">
                {% for langa in LANGUAGES %}
                    {% if forloop.last %}
                        {% if langa.1 ==  LANGUAGE_CODE %}
                           <li><a class="active" href="#" onclick="hizkuntza_url_egokitu(this);">{{ langa.1 }}</a></li>
                        {% else %}
                            <li><a href="#" onclick="hizkuntza_url_egokitu(this);">{{ langa.1 }}</a></li>
                        {% endif %}                    
                    {% else %}
                        {% if langa.1 == LANGUAGE_CODE %}
                            <li><a href="#" class="active" onclick="hizkuntza_url_egokitu(this);">{{ langa.1 }}</a></li>
                        {% else %}
                           <li> <a href="#" onclick="hizkuntza_url_egokitu(this);">{{ langa.1 }}</a></li>
                        {% endif %}                
                    {% endif %}
                {% endfor %}
                </ul>
            </form>  
		</div>
		<!-- LOGINA -->
		<div class="erabiltzaile-menua" >
			<a href="erregistratu">{% trans "Erregistratu" %} </a>
			<a href="logina">{% trans "Login" %} </a>
			<span class="glyphicon glyphicon-log-in" aria-hidden="true"> 
    	   	</span>
		</div>
	</div>	
	<!-- END LOGINA -->

	<!-- HEADER -->
	<div class="page-header">
		<a title="KulturBideak" href="http://www.kulturbideak.org/search">
 			<h1>K<small>ultur</small>B<small>ideak</small></h1>
 			<!--<img  alt="KulturBideak" href="kulturBideakLogoa.png"> -->
		</a>
		
	</div>
	
	<div class="erabiltzaile-menua" >
      	<a href="itema_gehitu">{% trans "Item berria gehitu" %} </a>
      	<span class="glyphicon glyphicon-upload" aria-hidden="true"> 
       	</span>
     <div>
	
	<!-- END HEADER -->	
		
	<!-- BILATZAILEA -->
		
	<div class="input-group">
		<form action="/search" method="get" class="form">
		{% csrf_token %}
		
			{% trans "Bilatu ..." as the_placeholder %}
      		<input id="id_q" class="form-control" type="search" title="" placeholder="{{ the_placeholder }}" name="q">
     		<span class="input-group-btn">
       			<button class="btn btn-default" type="submit">
       			   <span class="glyphicon glyphicon-search" aria-hidden="true"></span>	!
       			 </button>
       			
       			
      		</span>
      	</form>
      	
   	</div><!-- /input-group -->
		
	<!-- END BILATZAILEA -->
		
	<hr>	
	<!--PANTAILA EGITURA NAGUSIA-->
	<div class="orria">
	 	<div class="eskuma_div" align="right" >
	 		<b>{% trans "Hornitzaileak" %} </b>
	 	</div>	
				
		<div class="content_div" align="center">
			{% if mezua %}
				
				<div class="alert alert-info" role="alert"><strong>Ondo!</strong> {{mezua}}</div>

			{%endif%}
			
			{% block content %}
			
			{% endblock content %}
		</div>
		<div class="ezkerra_div" align="left">
			<b>{% trans "Ibilbide Ezagunak" %} </b>
			
			<br />
			<br />
			
			<!-- nire_ibilbideak javascript bidez kargatzen da-->	
			<div id="nire_ibilbideak"><b>{% trans "Nire Ibilbideak" %} </b></div>
		</div>
 	</div>	

</div> <!-- END PAGE -->
<hr>
<div class="footer">
	
	<div id="funding">
		<p></p>
		<p>
		<strong>Elhuyar Fundazioa</strong>
		<br>
		
		</p>
	</div>
	
</div>


<!--
</div>
</div>
-->
<!-- Latest compiled and minified JavaScript -->
<!--<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>-->
</body>
</html>

